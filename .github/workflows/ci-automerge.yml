name: CI Auto-Merge Operator

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PRç•ªå·'
        required: true
        type: number

permissions:
  contents: write
  pull-requests: write
  checks: read

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup GitHub CLI
        run: |
          gh --version
        env:
          GH_TOKEN: ${{ github.token }}
      
      - name: Run Auto-Merge Operator
        shell: pwsh
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          $pr = if ($env:GITHUB_EVENT_NAME -eq 'workflow_dispatch') {
            ${{ github.event.inputs.pr_number }}
          } else {
            ${{ github.event.pull_request.number }}
          }
          
          Write-Host "ğŸš€ Starting auto-merge operator for PR #$pr"
          
          # ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«èª­ã¿è¾¼ã¿
          Import-Module ./scripts/modules/CiUtils.psm1 -Force
          
          # contextsãƒã‚§ãƒƒã‚¯
          if (-not (Test-RequiredContextsAttached -PrNumber $pr)) {
            Write-Host "âŒ Required contexts mismatch detected" -ForegroundColor Red
            exit 2
          }
          
          # è‡ªå‹•ãƒãƒ¼ã‚¸å®Ÿè¡Œ
          ./scripts/ci_automerge.ps1 -Pr $pr -TimeoutMinutes 25
          
          if ($LASTEXITCODE -eq 0) {
            Write-Host "âœ… PR #$pr merged successfully" -ForegroundColor Green
          } elseif ($LASTEXITCODE -eq 2) {
            Write-Host "âš ï¸ Required contexts mismatch - manual fix required" -ForegroundColor Yellow
            exit 1
          } else {
            Write-Host "âŒ Auto-merge failed" -ForegroundColor Red
            exit 1
          }
      
      - name: Comment on Failure
        if: failure()
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number || github.event.inputs.pr_number }}
          body: |
            ## âš ï¸ Auto-Merge Failed
            
            è‡ªå‹•ãƒãƒ¼ã‚¸ãŒå¤±æ•—ã—ã¾ã—ãŸã€‚ä»¥ä¸‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„:
            
            - ğŸ” å¿…é ˆãƒã‚§ãƒƒã‚¯ãŒã™ã¹ã¦æˆåŠŸã—ã¦ã„ã¾ã™ã‹ï¼Ÿ
            - ğŸ” required contextsã¨å®Ÿéš›ã®ãƒã‚§ãƒƒã‚¯åãŒä¸€è‡´ã—ã¦ã„ã¾ã™ã‹ï¼Ÿ
            - ğŸ” PRãŒdraftã«ãªã£ã¦ã„ã¾ã›ã‚“ã‹ï¼Ÿ
            
            è©³ç´°ã¯[ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œãƒ­ã‚°](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
