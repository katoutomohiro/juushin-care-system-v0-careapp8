name: ci-automerge

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review, labeled, unlabeled]
  workflow_dispatch:
    inputs:
      pr:
        description: PR number
        required: true
        type: string

# æœ€å°æ¨©é™ï¼ˆå¿…è¦ååˆ†ï¼‰
permissions:
  contents: write          # ãƒãƒ¼ã‚¸ã§å¿…è¦
  pull-requests: write     # PR ã¸ã®æ›¸ãè¾¼ã¿ï¼ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹/ãƒãƒ¼ã‚¸æ“ä½œï¼‰
  checks: read             # ãƒã‚§ãƒƒã‚¯ã®å‚ç…§

# PR ã”ã¨ã«å˜ä¸€è·¯ç·šã«ã—ã¦å¤šé‡å‹•ä½œã‚’æŠ‘æ­¢
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || inputs.pr }}
  cancel-in-progress: true

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    # ãƒ•ã‚©ãƒ¼ã‚¯ç”±æ¥PRã¯é™¤å¤– + ux-readyãƒ©ãƒ™ãƒ«å¿…é ˆ + no-auto-mergeã§éå¸¸åœæ­¢
    if: >
      (github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository) &&
      (github.event_name == 'workflow_dispatch' || (
        contains(fromJson(toJson(github.event.pull_request.labels)).*.name, 'ux-ready') &&
        !contains(fromJson(toJson(github.event.pull_request.labels)).*.name, 'no-auto-merge')
      ))
    timeout-minutes: 30
    
    steps:
      - name: Debug gating context (safe)
        env:
          EVENT_NAME: ${{ github.event_name }}
          ACTOR: ${{ github.actor }}
          HEAD_REF: ${{ github.head_ref }}
          DRAFT: ${{ github.event.pull_request.draft }}
          LABELS_JSON: ${{ toJson(github.event.pull_request.labels) }}
        run: |
          echo "event_name=${EVENT_NAME}"
          echo "actor=${ACTOR}"
          echo "head_ref=${HEAD_REF}"
          echo "draft=${DRAFT}"
          echo "labels=$(printf '%s' "$LABELS_JSON" | jq -r '.[].name' | paste -sd, -)"
      
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup GitHub CLI
        run: |
          gh --version
        env:
          GH_TOKEN: ${{ github.token }}
      
      - name: Run Auto-Merge Operator (safe)
        shell: pwsh
        env:
          GH_TOKEN: ${{ github.token }}
          EVENT_NAME: ${{ github.event_name }}
          INPUT_PR: ${{ inputs.pr }}
          PULL_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          $event = $env:EVENT_NAME
          $rawPr = if ($event -eq 'workflow_dispatch') { $env:INPUT_PR } else { $env:PULL_NUMBER }
          # sanitize: digits only
          $pr = ($rawPr -replace "[^0-9]", "")
          if (-not $pr) {
            Write-Host "âŒ Invalid PR number input" -ForegroundColor Red
            exit 1
          }

          Write-Host "ğŸš€ Starting auto-merge operator for PR #$pr"

          # ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«èª­ã¿è¾¼ã¿
          Import-Module ./scripts/modules/CiUtils.psm1 -Force

          # contextsãƒã‚§ãƒƒã‚¯
          if (-not (Test-RequiredContextsAttached -PrNumber $pr)) {
            Write-Host "âŒ Required contexts mismatch detected" -ForegroundColor Red
            exit 2
          }

          # è‡ªå‹•ãƒãƒ¼ã‚¸å®Ÿè¡Œ
          ./scripts/ci_automerge.ps1 -Pr $pr -TimeoutMinutes 25

          if ($LASTEXITCODE -eq 0) {
            Write-Host "âœ… PR #$pr merged successfully" -ForegroundColor Green
          } elseif ($LASTEXITCODE -eq 2) {
            Write-Host "âš ï¸ Required contexts mismatch - manual fix required" -ForegroundColor Yellow
            exit 1
          } else {
            Write-Host "âŒ Auto-merge failed" -ForegroundColor Red
            exit 1
          }
      
      - name: Comment on Failure
        if: failure()
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number || inputs.pr }}
          body: |
            ## âš ï¸ Auto-Merge Failed
            
            è‡ªå‹•ãƒãƒ¼ã‚¸ãŒå¤±æ•—ã—ã¾ã—ãŸã€‚ä»¥ä¸‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„:
            
            - ğŸ” å¿…é ˆãƒã‚§ãƒƒã‚¯ãŒã™ã¹ã¦æˆåŠŸã—ã¦ã„ã¾ã™ã‹ï¼Ÿ
            - ğŸ” required contextsã¨å®Ÿéš›ã®ãƒã‚§ãƒƒã‚¯åãŒä¸€è‡´ã—ã¦ã„ã¾ã™ã‹ï¼Ÿ
            - ğŸ” PRãŒdraftã«ãªã£ã¦ã„ã¾ã›ã‚“ã‹ï¼Ÿ
            
            è©³ç´°ã¯[ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œãƒ­ã‚°](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
