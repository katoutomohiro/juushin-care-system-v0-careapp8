# ケアシステム新モデル導入計画

## 🎯 最重要ルール（必ず守る）

1. **A・Tさんのケース記録を完璧に完成させることが最優先**。その後、同じ仕組みで23人の利用者のケース記録を順に生成する。
2. **ケース記録は共通項目と個別項目が混在**する。個別項目は利用者ごとに慎重に作り、1人ずつ「要件確定→実装→検証→次へ進む」の流れを守る。
3. **プランファイルは常に最新状態**を保つ。変更・修正・追加のたびに必ず更新し、AI/人が読んで状況が理解できるようにする。
4. 変更仕様が途中で発生したら、その都度このプランに反映してから実装を進める。

## 📋 開発方針

**リマインダー（変更不可）**
- 最初は A・T さんを完璧に仕上げる → その後 23 名を個別に順番対応
- 共通項目 + 利用者ごとの個別項目がある前提で、利用者ごとに慎重に作成する
- 仕様変更が入るたびに必ずこの plan.md を更新し、履歴を残す

### A・Tさんを基準とした段階的開発

- **フェーズ1**: A・Tさんのケース記録フォームを「完璧な状態」まで仕上げる
  - UI/UX の整備（日付ピッカー、時刻自動入力など）
  - フォーム検証とエラーハンドリング
  - 保存・編集・削除の一連の動作確認
  - 印刷・PDF出力の検証
  
- **フェーズ2**: 仕上がったA・Tさんの仕組みを「テンプレート」として、他23人を順に作成

### 共通項目 vs 個別項目の管理

**共通項目（全利用者対象）:**
- 日付（YYYY/MM/DD(曜)形式表示、内部は ISO形式）
- 時刻（HH:mm形式、「今すぐ」ボタン付き）
- 利用者ID、サービスID
- スタッフ（主・副）

**個別項目（利用者ごと）:**
- バイタル（測定項目は人による）
- 食事・栄養摂取
- 排泄
- 理学療法 / 作業療法（障害種別により異なる）
- 特記事項

### 変更・修正・追加が都度入る前提での運用

- このプランは「最初から完全な仕様」ではない
- 実装中に「この項目が必要」「この表示形式に変更」が発生する
- その都度、要件をこのファイルに追記 → 実装 → 検証 の流れを繰り返す
- 仕様変更の追跡性を確保するため、実装ログも「いつ何を変えたか」を記録する

## 背景

A.T様のケース記録を基準に、全利用者に共通したケース記録システムを構築し、保存用APIを一本化し、現在の冗長な保存処理や通知機能を削減する。このプランは実装手順の指針として、今後の開発で必ず参照するファイルである。

## 作業ステップ

1. **ケース記録データモデルの更新**
    - A.T様の記録内容をベースに、新しい `CaseRecord` 型を定義する。JSON型を採用し、各カテゴリー（バイタル・排泄・水分・食事・その他）のデータを柔軟に保持できるようにする。
    - 1日1利用者1レコードを基本とし、`userId`、`date`、`entries` (カテゴリー毎の配列) 等で構成する。
    - カテゴリーは必要に応じて追加可能とし、使用しないカテゴリーは空配列で構わない。
    - 既存データの移行は後で検討。まずは新規入力でこの形式を採用する。

2. **保存APIの統合**
    - 新しいケース記録保存エンドポイント `/api/case-records/save` を実装する。
    - 他の保存エンドポイントや通知処理は一時的に停止し、このエンドポイントを唯一の保存手段とする。
    - `POST` で受け取った新 `CaseRecord` JSONを保存し、保存完了時には成功ステータスと保存されたデータを返す。
    - フロントエンドの各フォーム・ページの保存処理を、既存の `DataStorageService.saveCaseRecord` 呼び出しから、上記API呼び出しに変更する。

3. **最小構成での稼働**
    - 現在実装されている通知機能や管理機能は一旦無効にする。
    - A.T様のケース記録フォームを新モデルに対応させ、印刷、署名取得、データ保存が正しく行えるか検証する。
    - 他利用者のケース記録は未対応でも構わないため、必要最低限の画面のみ保持する。

## 実装順序

1. `services/data-storage-service.ts` 等で `CaseRecord` 型定義を更新し、保存ロジックを新形式に対応させる。
2. `app/api/case-records/save/route.ts` を新規作成し、保存処理を実装する。
3. A.T様のケース記録ページと関連コンポーネントを新形式に合わせて修正する。
4. 他ページに残っている旧API呼び出し・不要な機能をコメントアウトまたは削除する。

## 注意事項

- この計画書（plan.md）は将来的に編集・追加される可能性がある。実装前に必ず最新版を読み込んでから作業を開始すること。
- 開発中は `pnpm tsc --noEmit` を用いて型エラーの確認を行い、エラーが発生しないことを確認しながら進める。

## 進捗メモ（更新は段階的に反映してOK）

- 旧 `/api/case-records` は停止し、保存は `/api/case-records/save` に一本化済み。
- 旧API参照の残存チェックを実施し、ドキュメントも `/api/case-records/save` に統一済み。
- `services/data-storage-service.ts` に `CaseRecord`（JSONベース）を追加し、保存ロジックを新APIへ切替済み。
- 管理機能は一時的に無効化済み（最小構成で運用）。

### 2026-01-14: A・Tさんケース記録フォーム - 日付フォーマット機能の実装

**実装内容:**
- `src/components/fields/DateWithWeekdayField.tsx` を新規作成（共通コンポーネント）
  - 表示用の読み取り専用テキスト入力（クリックで picker を開く）
  - 裏の実 `input type="date"` で日付値を管理
  - 選択日付を「YYYY/MM/DD(曜)」形式で表示
  - Safari対策で「YYYY-MM-DD」を自動パース（new Date直渡し避ける）
  
- `src/components/case-records/HeaderFields.tsx` を更新
  - 既存の日付フィールド実装を削除
  - 新しい `DateWithWeekdayField` コンポーネントに置き換え
  - 内部保存は ISO形式（YYYY-MM-DD）を維持

**対象ファイル:**
- `src/components/fields/DateWithWeekdayField.tsx` (NEW)
- `src/components/case-records/HeaderFields.tsx` (UPDATED)

**受け入れ条件:**
- ✅ A・Tさんのケース記録画面で日付欄をクリックするとカレンダーが出る
- ✅ 日付選択後、「YYYY/MM/DD(曜)」が欄内に即座に表示される
- ✅ 保存時に date が ISO形式（YYYY-MM-DD）で送信される
- ✅ クロスブラウザ対応（Safari対策済み）

### 2026-01-14: A・Tさんケース記録フォーム - 時刻「今すぐ」ボタン機能の実装

**実装内容:**
- `src/components/fields/TimeWithNowField.tsx` を新規作成（共通コンポーネント）
  - 時刻入力欄（type="time"、HH:mm形式）
  - 右側に「今すぐ」ボタン（absolute配置）
  - ボタン押下で現在時刻を自動入力（例：10:30）
  - 手入力による修正は常に可能

- `src/components/case-records/HeaderFields.tsx` を更新
  - 既存の時刻フィールド実装を削除
  - 新しい `TimeWithNowField` コンポーネントに置き換え

**対象ファイル:**
- `src/components/fields/TimeWithNowField.tsx` (NEW)
- `src/components/case-records/HeaderFields.tsx` (UPDATED)

**時刻仕様（次の利用者追加時の参考）:**
- 表示形式: HH:mm（24時間制）
- 「今すぐ」ボタンで現在時刻を自動入力
- 手入力で修正可能
- 保存・印刷で同じ値を使用
- 内部保存形式: HH:mm

**受け入れ条件:**
- ✅ A・Tさんのケース記録画面で「今すぐ」ボタンが表示される
- ✅ ボタン押下で現在時刻が HH:mm 形式で入力される
- ✅ 時刻を手入力で修正可能
- ✅ 保存時に time が HH:mm 形式で送信される
- ✅ Console にエラーなし

### 2026-01-14: A・Tさんケース記録フォーム - 時刻フィールド修正（Phase2、import整合）

**実装内容:**
- `TimeWithNowField` を default export に統一し、呼び出し側の import 不整合を解消
- 時計アイコン非表示のうえ、入力枠内右端に「今すぐ」ボタンを絶対配置（枠内固定）
- onClick で現在時刻 HH:mm を生成し、`{ target: { name, value } }` 形式で親に返却
- type="time" + 右 padding を確保（pr-20）し、UI崩れを防止

**対象ファイル:**
- `src/components/fields/TimeWithNowField.tsx` (UPDATED)
- `src/components/TimeWithNowField.tsx` (RE-EXPORT)
- `src/components/case-records/HeaderFields.tsx` (UPDATED)
- `app/globals.css` (time picker icon 非表示)

**受け入れ条件:**
- ✅ モジュール解決エラー（Module not found: Can't resolve '@/components/TimeWithNowField'）が解消されビルドが通る
- ✅ 時刻欄の右端に「今すぐ」が枠内表示され、時計アイコンは表示されない
- ✅ 「今すぐ」押下で現在時刻が HH:mm で即反映、手入力も可能
- ✅ 保存時に payload の time が HH:mm で送信される
- ✅ Console にエラーなし

## 次のステップ（アイデアメモ）

- 記録一覧表示（利用者 × 日付での検索・フィルタ）
- 6か月単位の評価・振り返り画面
