# DATA_RETENTION - データ保存・削除ポリシー

**Version**: 1.0  
**Last Updated**: 2026-02-20  
**Status**: 確定版（フェーズ1ドキュメント）  

---

## 📌 概要

本ドキュメントは、重心ケアアプリにおける**データの保存期間・削除ポリシー・バックアップ・エクスポート**に関する要件を定義します。

### 設計原則

1. **法令遵守**: 医療法・介護保険法・個人情報保護方針に準拠
2. **オペレーションコスト最適化**: 不要な古いデータは定期削除
3. **監査証跡保持**: 監査ログは長期保存
4. **消費者の権利**: ユーザーによるデータ削除・エクスポートを支援

---

## 📊 データ種別別保存期間ポリシー

### 1. ケース記録（case_records）

**状況**:
- **利用中のユーザー**: 保存継続
- **利用終了のユーザー**: 利用終了日から N 年後に削除

**保存期間**: 要確認 ⏳

| 段階 | 期間 | 詳細 |
|------|------|------|
| **アクティブ** | 利用終了まで | データ参照・編集可能 |
| **アーカイブ** | 1～2 年 | 参照のみ可能、編集不可 |
| **削除対象** | 2～7 年後 | 削除除外リストに登録で保存期間延長可 |

**確認タスク**: 組織の個人情報ポリシーで保存期間を確認し、上表を更新してください。

### 2. 利用者基本情報（care_receivers）

**original ルール**:
- full_name, birthday, address, phone, emergency_contact などの PII
- 利用終了後 3 ～ 7 年保存が一般的（法令依存）

| 項目 | 保存期間 | 削除対象 | 備考 |
|------|--------|--------|------|
| display_name | 制限なし | ❌ | 匿名識別子のため保存継続 |
| full_name（実名） | 利用終了 + 3～7 年 | 💀 | 医療法準拠（要確認） |
| birthday, address, phone | 利用終了 + 3～7 年 | 💀 | PII として長期保存禁止（要確認） |
| medical_care_detail | 利用終了 + 7 年 | 💀 | 医療情報として長期保存（法令準拠） |

**確認タスク**: 医療法・個人情報保護方針で PII 保存期間を確認してください。

### 3. 職員情報（staff, staff_profiles）

**staff テーブル（service マスタ）**:
- 保存期間: 無制限（サービス提供中は保存）
- 削除: service 廃止時のみ

**staff_profiles テーブル（ユーザー権限）**:
- 保存期間: 無制限（auth.users に紐付く）
- 削除: ユーザーが離職時に本人申告で削除可（Right to be Forgotten）

| 項目 | 保存期間 | 削除契機 |
|------|--------|--------|
| service_id, name（職員マスタ） | 無制限 | service 廃止時 |
| staff_profiles.display_name | 無制限 | 離職・本人申告時 |

### 4. 監査ログ（audit_logs）

**ルール**: 分析・合法性証明のためのログ

| 区分 | 保存期間 | 削除方法 | 根拠 |
|------|--------|--------|------|
| 通常ログ | 3～5 年 | 自動削除scripts | 個人情報保護法 |
| セキュリティ関連 | 5～7 年 | 監査部門判断で延長 | HIPAA 準拠 |
| 削除操作のログ | 7 年 | 保存延長対象 | 改ざん・情報隠蔽対策 |

**確認タスク**: 組織の監査ポリシーで保存期間を確認してください。

### 5. 添付ファイル（Vercel Blob）

**images/screenshots（case_record 添付）**:
- 保存期間: 親の case_record と同じ
- 削除: case_record 削除時に連動削除

**バックアップファイル**:
- 保存期間: バックアップ世代管理ポリシーに従う
- 世代数: 直近 30 日間は毎日、過去 1 年は週単位

---

## 🗑️ 削除ポリシー（自動化）

### 概要: 定期削除スクリプト

```
cron: 毎月 1 日 深夜 0 時（UTC）
┌─ care_receivers 削除（PII）
│  ├─ condition: 利用終了日 + 7 年経過
│  └─ action: full_name, address, phone を NULL に（soft delete）
├─ case_records 削除（コンテンツ）
│  ├─ condition: 利用終了日 + 7 年経過
│  └─ action: 物理削除（hard delete）
├─ audit_logs 削除（古いログ）
│  ├─ condition: 作成日 + 5 年経過
│  └─ action: 物理削除
└─ blob ファイル削除
   ├─ condition: 親 case_record 削除
   └─ action: Vercel Blob API で削除
```

---

## 💾 バックアップポリシー

### 定義

| 項目 | 値 | 備考 |
|------|-----|-------|
| **RPO**（Recovery Point Objective） | 1 日 | 最大 1 日分のデータ損失を許容 |
| **RTO**（Recovery Time Objective） | 4 時間 | 最大 4 時間でシステム復旧 |
| **バックアップ頻度** | 毎日 1 回以上 | Supabase の自動バックアップ利用 |
| **保有世代数** | 30 日間（毎日 + 1 年週単位） | 過去 1 年分を保有 |

---

## 📋 チェックリスト

実装前に以下を確認：

- [ ] 組織の個人情報保護ポリシーで PII 保存期間を確認（3～7 年？）
- [ ] 医療法での医療情報保存期間を確認（通常 7 年）
- [ ] 監査ログ保存期間を監査部門に確認（3～5 年？）
- [ ] バックアップ リストア手順を整備（マニュアル検証）
- [ ] GDPR 対応の要否を確認（EU ユーザー対象か）

---

## 参照

- [SECURITY_MODEL.md](./SECURITY_MODEL.md) - セキュリティ設計
- [AUDIT_LOGGING.md](./AUDIT_LOGGING.md) - 監査ログ詳細
- [DOMAIN_MODEL.md](./DOMAIN_MODEL.md) - テーブル設計
